<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA Management - Complete System</title>
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f0f;
            color: #fff;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .tab {
            padding: 12px 24px;
            background: #1a1a1a;
            border: none;
            color: #888;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        .tab.active { background: #2a2a2a; color: #fff; }
        .tab:hover { background: #252525; }
        .section { display: none; }
        .section.active { display: block; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary { background: #3b82f6; color: #fff; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-warning { background: #f59e0b; color: #fff; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn:hover { opacity: 0.9; }
        .card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .card h3 { margin-bottom: 10px; font-size: 18px; }
        .card-info { margin-bottom: 15px; line-height: 1.8; color: #aaa; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 20px; }
        .close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #0f0f0f;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        .hidden { display: none !important; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #888;
            font-size: 14px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>VA Management System</h1>
            <button data-action="logout" class="btn btn-danger">Logout</button>
        </div>

        <div class="tabs">
            <button data-tab="dashboard" class="tab active">Dashboard</button>
            <button data-tab="vas" class="tab">Virtual Assistants</button>
            <button data-tab="onboardings" class="tab">Onboardings</button>
            <button data-tab="offboardings" class="tab">Offboardings</button>
            <button data-tab="creators" class="tab">Creators</button>
            <button data-tab="payments" class="tab">Payments</button>
            <button data-tab="phones" class="tab">Phones</button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section active">
            <div class="stats" id="stats"></div>
        </div>

        <!-- VAs Section -->
        <div id="vas-section" class="section">
            <button data-action="add-va" class="btn btn-primary" style="margin-bottom: 20px;">Add VA</button>
            <div id="va-list"></div>
        </div>

        <!-- Onboardings Section -->
        <div id="onboardings-section" class="section">
            <h2 style="margin-bottom: 20px; font-size: 24px;">Pending Onboardings</h2>
            <p style="color: #888; margin-bottom: 20px;">VAs who haven't completed their onboarding checklist yet</p>
            <div id="onboarding-list"></div>
        </div>

        <!-- Offboardings Section -->
        <div id="offboardings-section" class="section">
            <h2 style="margin-bottom: 20px; font-size: 24px;">Offboarded VAs</h2>
            <p style="color: #888; margin-bottom: 20px;">Archived VAs with offboarding details</p>
            <div id="offboarding-list"></div>
        </div>

        <!-- Creators Section -->
        <div id="creators-section" class="section">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button data-action="add-creator" class="btn btn-primary">Add Creator</button>
                <button id="sync-assignments-btn" class="btn" style="background: rgba(234, 179, 8, 0.15); border: 1px solid #eab308; color: #fde047;">
                    üîÑ Sync All VA-Creator Assignments
                </button>
            </div>
            <div id="creator-list"></div>
        </div>

        <!-- Payments Section -->
        <div id="payments-section" class="section">
            <h2 style="margin-bottom: 20px; font-size: 24px;">Payment Groups</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button data-action="add-payment-group" class="btn btn-primary">Add Payment Group</button>
            </div>
            <div id="payment-groups-list"></div>

            <h2 style="margin: 40px 0 20px 0; font-size: 24px;">Payment Records</h2>
            <div style="margin-bottom: 20px;">
                <button data-action="record-payment" class="btn btn-success">Record Payment</button>
            </div>
            <div id="payment-list"></div>
        </div>

        <!-- Phones Section -->
        <div id="phones-section" class="section">
            <button data-action="add-phone" class="btn btn-primary" style="margin-bottom: 20px;">Add Phone</button>
            <div id="phone-list"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal show">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Add VA Modal -->
    <div id="add-va-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add VA</h2>
                <button class="close" data-action="close-modal" data-modal="add-va-modal">&times;</button>
            </div>
            <form id="add-va-form">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="add-va-upload-photo" class="btn btn-primary" style="width: auto;">Upload Photo</button>
                        <div id="add-va-photo-preview" style="display: none; align-items: center; gap: 10px;">
                            <img id="add-va-photo-img" src="" alt="Preview" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6;">
                            <span id="add-va-photo-name" style="font-size: 12px; color: #888;"></span>
                        </div>
                    </div>
                    <input type="hidden" name="profile_photo_url" id="add-va-photo-url">
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="full_name" required>
                </div>
                <div class="form-group">
                    <label>Telegram Handle *</label>
                    <input type="text" name="telegram_handle" required>
                </div>
                <div class="form-group">
                    <label>VA Type</label>
                    <select name="va_type">
                        <option value="editor">Editor</option>
                        <option value="social_media">Social Media</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Onboarding Date</label>
                    <input type="date" name="onboarding_date" min="2020-01-01" max="2030-12-31">
                    <small style="color: #888; font-size: 12px;">For payment stage calculation (Month 1: $150, Month 2: $200, Month 3+: $300)</small>
                </div>
                <div class="form-group" id="add-va-custom-salary-group" style="display: none;">
                    <label>Custom Salary (for non-social-media VAs)</label>
                    <input type="number" name="custom_salary" id="add-va-custom-salary" step="0.01" min="0" placeholder="e.g., 600.00">
                    <small style="color: #888; font-size: 12px;">Fixed monthly salary for editors, managers, specialists</small>
                </div>
                <div class="form-group">
                    <label>Payment Group</label>
                    <select name="payment_group_id" id="add-va-payment-group">
                        <option value="">No Group</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Add VA</button>
            </form>
        </div>
    </div>

    <!-- Edit VA Modal -->
    <div id="edit-va-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit VA</h2>
                <button class="close" data-action="close-modal" data-modal="edit-va-modal">&times;</button>
            </div>
            <form id="edit-va-form">
                <input type="hidden" name="id">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="edit-va-upload-photo" class="btn btn-primary" style="width: auto;">Upload Photo</button>
                        <div id="edit-va-photo-preview" style="display: none; align-items: center; gap: 10px;">
                            <img id="edit-va-photo-img" src="" alt="Preview" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6;">
                            <span id="edit-va-photo-name" style="font-size: 12px; color: #888;"></span>
                        </div>
                    </div>
                    <input type="hidden" name="profile_photo_url" id="edit-va-photo-url">
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" name="full_name" required>
                </div>
                <div class="form-group">
                    <label>Telegram Handle</label>
                    <input type="text" name="telegram_handle" required>
                </div>
                <div class="form-group">
                    <label>VA Type</label>
                    <select name="va_type">
                        <option value="editor">Editor</option>
                        <option value="social_media">Social Media</option>
                        <option value="manager">Manager</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Onboarding Date</label>
                    <input type="date" name="onboarding_date" id="edit-va-onboarding-date" min="2020-01-01" max="2030-12-31">
                    <small style="color: #888; font-size: 12px;">For payment stage calculation (Month 1: $150, Month 2: $200, Month 3+: $300)</small>
                </div>
                <div class="form-group">
                    <label>Managing Creator</label>
                    <select name="creator_id" id="edit-va-creator-select">
                        <option value="">None</option>
                    </select>
                    <small style="color: #888; font-size: 12px;">Which creator does this VA manage?</small>
                </div>
                <div class="form-group" id="edit-va-custom-salary-group" style="display: none;">
                    <label>Custom Salary (for non-social-media VAs)</label>
                    <input type="number" name="custom_salary" id="edit-va-custom-salary" step="0.01" min="0" placeholder="e.g., 600.00">
                    <small style="color: #888; font-size: 12px;">Fixed monthly salary for editors, managers, specialists</small>
                </div>
                <div class="form-group">
                    <label>Payment Group</label>
                    <select name="payment_group_id" id="edit-va-payment-group">
                        <option value="">No Group</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status" id="edit-va-status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Add Creator Modal -->
    <div id="add-creator-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Creator</h2>
                <button class="close" data-action="close-modal" data-modal="add-creator-modal">&times;</button>
            </div>
            <form id="add-creator-form">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="add-creator-upload-photo" class="btn btn-primary" style="width: auto;">Upload Photo</button>
                        <div id="add-creator-photo-preview" style="display: none; align-items: center; gap: 10px;">
                            <img id="add-creator-photo-img" src="" alt="Preview" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6;">
                            <span id="add-creator-photo-name" style="font-size: 12px; color: #888;"></span>
                        </div>
                    </div>
                    <input type="hidden" name="profile_photo_url" id="add-creator-photo-url">
                </div>
                <div class="form-group">
                    <label>Creator Name *</label>
                    <input type="text" name="creator_name" required>
                </div>
                <div class="form-group">
                    <label>Wallet Address</label>
                    <input type="text" name="wallet_address" placeholder="0x...">
                    <small style="color: #888; font-size: 12px;">Crypto wallet for payments</small>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Add Creator</button>
            </form>
        </div>
    </div>

    <!-- Edit Creator Modal -->
    <div id="edit-creator-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Creator</h2>
                <button class="close" data-action="close-modal" data-modal="edit-creator-modal">&times;</button>
            </div>
            <form id="edit-creator-form">
                <input type="hidden" name="id">
                <div class="form-group">
                    <label>Profile Photo</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button type="button" id="edit-creator-upload-photo" class="btn btn-primary" style="width: auto;">Upload Photo</button>
                        <div id="edit-creator-photo-preview" style="display: none; align-items: center; gap: 10px;">
                            <img id="edit-creator-photo-img" src="" alt="Preview" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6;">
                            <span id="edit-creator-photo-name" style="font-size: 12px; color: #888;"></span>
                        </div>
                    </div>
                    <input type="hidden" name="profile_photo_url" id="edit-creator-photo-url">
                </div>
                <div class="form-group">
                    <label>Creator Name</label>
                    <input type="text" name="creator_name" required>
                </div>
                <div class="form-group">
                    <label>Wallet Address</label>
                    <input type="text" name="wallet_address" id="edit-creator-wallet" placeholder="0x...">
                    <small style="color: #888; font-size: 12px;">Crypto wallet for payments</small>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Complete Onboarding Modal -->
    <div id="complete-onboarding-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Complete Onboarding</h2>
                <button class="close" data-action="close-modal" data-modal="complete-onboarding-modal">&times;</button>
            </div>
            <form id="complete-onboarding-form">
                <input type="hidden" name="va_id" id="onboarding-va-id">

                <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #3b82f6;">VA Information</h3>
                    <div id="onboarding-va-info" style="font-size: 13px; color: #888;"></div>
                </div>

                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #e5e7eb;">Onboarding Checklist</h3>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" name="apple_code_provided" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Apple Code Provided</span>
                    </label>
                    <small style="color: #888; font-size: 12px; margin-left: 30px;">Apple ID/code for app downloads</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" name="proxy_configured" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Proxy Configured</span>
                    </label>
                    <small style="color: #888; font-size: 12px; margin-left: 30px;">Proxy settings configured on device</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" name="training_materials_provided" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Training Materials Provided</span>
                    </label>
                    <small style="color: #888; font-size: 12px; margin-left: 30px;">SOPs and training documentation shared</small>
                </div>

                <div class="form-group">
                    <label>Phone Setup</label>
                    <select name="phone_type" id="onboarding-phone-type" required>
                        <option value="">Select phone type...</option>
                        <option value="new">New Phone</option>
                        <option value="transfer">Transfer from Another VA</option>
                    </select>
                </div>

                <div class="form-group" id="phone-transfer-group" style="display: none;">
                    <label>Transfer Phone From</label>
                    <input type="text" id="phone-from-va-search" placeholder="Search VAs..." style="margin-bottom: 8px; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #2a2a2a; color: #fff; width: 100%;">
                    <select name="phone_from_va_id" id="phone-from-va-select" size="5" style="width: 100%; max-height: 150px;">
                        <option value="">Select VA...</option>
                    </select>
                    <small style="color: #888; font-size: 12px;">Which VA is transferring their phone to this VA?</small>
                </div>

                <div id="phone-details-group" style="display: none; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #888;">üì± Phone Details</h4>

                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" name="phone_number" id="onboarding-phone-number" placeholder="+1234567890">
                    </div>

                    <div class="form-group">
                        <label>Handout Date</label>
                        <input type="text" name="handout_date" id="onboarding-handout-date" placeholder="e.g., 2024-10-27 or 27.10.2024">
                        <small style="color: #888; font-size: 12px;">Enter date in any format</small>
                    </div>

                    <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #888;">üçé Apple ID Credentials</h4>

                        <div class="form-group">
                            <label>Apple ID Email</label>
                            <input type="email" name="apple_id_email" id="onboarding-apple-id-email" placeholder="example@icloud.com">
                        </div>

                        <div class="form-group">
                            <label>Apple ID Password</label>
                            <input type="password" name="apple_id_password" id="onboarding-apple-id-password" placeholder="Apple ID password" autocomplete="new-password">
                        </div>
                    </div>

                    <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #888;">üåê Proxy Configuration</h4>

                        <div class="form-group">
                            <label>Proxy Address</label>
                            <input type="text" name="proxy_ip" id="onboarding-proxy-ip" placeholder="proxy.example.com">
                        </div>

                        <div class="form-group">
                            <label>Proxy Port</label>
                            <input type="number" name="proxy_port" id="onboarding-proxy-port" placeholder="8080">
                        </div>

                        <div class="form-group">
                            <label>Proxy Username</label>
                            <input type="text" name="proxy_username" id="onboarding-proxy-username" placeholder="username">
                        </div>

                        <div class="form-group">
                            <label>Proxy Password</label>
                            <input type="password" name="proxy_password" id="onboarding-proxy-password" placeholder="password" autocomplete="new-password">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Phone Notes</label>
                        <textarea name="phone_notes" id="onboarding-phone-notes" rows="2" placeholder="Any additional notes about this phone..."></textarea>
                    </div>
                </div>

                <button type="button" id="copy-onboarding-details-btn" class="btn" style="width: 100%; margin-bottom: 10px; background: rgba(59, 130, 246, 0.15); border: 1px solid #3b82f6; color: #60a5fa;">
                    üìã Copy All Details for Supervisor
                </button>
                <button type="submit" class="btn btn-success" style="width: 100%;">‚úì Complete Onboarding</button>
            </form>
        </div>
    </div>

    <!-- Offboard VA Modal -->
    <div id="offboard-va-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Offboard VA</h2>
                <button class="close" data-action="close-modal" data-modal="offboard-va-modal">&times;</button>
            </div>
            <form id="offboard-va-form">
                <input type="hidden" name="va_id" id="offboard-va-id">

                <div style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px; border-left: 4px solid #ef4444;">
                    <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #ef4444;">‚ö†Ô∏è Warning</h3>
                    <div id="offboard-va-info" style="font-size: 13px; color: #888;"></div>
                    <p style="color: #ef4444; font-size: 13px; margin: 10px 0 0 0;">This action will archive the VA and cannot be undone.</p>
                </div>

                <div class="form-group">
                    <label>Reason for Offboarding</label>
                    <select name="reason" required>
                        <option value="">Select reason...</option>
                        <option value="performance">Performance Issues</option>
                        <option value="resignation">Resignation</option>
                        <option value="contract_end">Contract End</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Details</label>
                    <textarea name="reason_details" rows="3" placeholder="Additional details about the offboarding..."></textarea>
                </div>

                <div class="form-group">
                    <label>Final Payment</label>
                    <input type="number" name="final_payment" step="0.01" min="0" placeholder="e.g., 300.00">
                    <small style="color: #888; font-size: 12px;">Final payment amount (if applicable)</small>
                </div>

                <div class="form-group">
                    <label>Phone Handling</label>
                    <select name="phone_handling" id="offboard-phone-handling" required>
                        <option value="">Select option...</option>
                        <option value="transfer">Transfer to Another VA</option>
                        <option value="inventory">Return to Inventory</option>
                        <option value="none">No Phone Assigned</option>
                    </select>
                </div>

                <div class="form-group" id="offboard-phone-transfer-group" style="display: none;">
                    <label>Transfer Phone To</label>
                    <input type="text" id="offboard-phone-transfer-search" placeholder="Search VAs..." style="margin-bottom: 8px; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #2a2a2a; color: #fff; width: 100%;">
                    <select name="phone_transferred_to_va_id" id="offboard-phone-transfer-select" size="5" style="width: 100%; max-height: 150px;">
                        <option value="">Select VA...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" rows="2" placeholder="Additional notes..."></textarea>
                </div>

                <div class="form-group">
                    <label>Offboarded By</label>
                    <input type="text" name="offboarded_by" required placeholder="Your name">
                </div>

                <button type="submit" class="btn" style="width: 100%; background: #ef4444;">Offboard VA</button>
            </form>
        </div>
    </div>

    <!-- Add Payment Group Modal -->
    <div id="add-payment-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Payment Group</h2>
                <button class="close" data-action="close-modal" data-modal="add-payment-group-modal">&times;</button>
            </div>
            <form id="add-payment-group-form">
                <div class="form-group">
                    <label>Group Name *</label>
                    <input type="text" name="group_name" required placeholder="Family A">
                </div>
                <div class="form-group">
                    <label>Leader Name *</label>
                    <input type="text" name="leader_name" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label>Wallet Address *</label>
                    <input type="text" name="wallet_address" required placeholder="0x...">
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Create Payment Group</button>
            </form>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div id="record-payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Payment</h2>
                <button class="close" data-action="close-modal" data-modal="record-payment-modal">&times;</button>
            </div>
            <form id="record-payment-form">
                <div class="form-group">
                    <label>VA *</label>
                    <select name="va_id" id="payment-va-select" required>
                        <option value="">Select VA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Payment Date *</label>
                    <input type="date" name="payment_date" required>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Record Payment</button>
            </form>
        </div>
    </div>

    <!-- Add Phone Modal -->
    <div id="add-phone-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Phone</h2>
                <button class="close" data-action="close-modal" data-modal="add-phone-modal">&times;</button>
            </div>
            <form id="add-phone-form">
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="text" name="phone_number" required>
                </div>

                <div class="form-group">
                    <label>Assigned VA</label>
                    <select name="va_id" id="phone-va-select">
                        <option value="">None</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Handout Date</label>
                    <input type="text" name="handout_date" placeholder="e.g., 2024-10-27 or 27.10.2024">
                    <small style="color: #888; font-size: 12px;">Enter date in any format</small>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #888;">Apple ID Credentials</h4>

                    <div class="form-group">
                        <label>Apple ID Email</label>
                        <input type="email" name="apple_id_email" placeholder="example@icloud.com">
                    </div>

                    <div class="form-group">
                        <label>Apple ID Password</label>
                        <input type="password" name="apple_id_password" placeholder="Apple ID password" autocomplete="new-password">
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #888;">Proxy Configuration</h4>

                    <div class="form-group">
                        <label>Proxy Address</label>
                        <input type="text" name="proxy_ip" placeholder="proxy.example.com">
                    </div>

                    <div class="form-group">
                        <label>Proxy Port</label>
                        <input type="number" name="proxy_port" placeholder="8080">
                    </div>

                    <div class="form-group">
                        <label>Proxy Username</label>
                        <input type="text" name="proxy_username" placeholder="username">
                    </div>

                    <div class="form-group">
                        <label>Proxy Password</label>
                        <input type="password" name="proxy_password" placeholder="password" autocomplete="new-password">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%;">Add Phone</button>
            </form>
        </div>
    </div>

    <!-- Edit Phone Modal -->
    <div id="edit-phone-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Phone</h2>
                <button class="close" data-action="close-modal" data-modal="edit-phone-modal">&times;</button>
            </div>
            <form id="edit-phone-form">
                <input type="hidden" name="id">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" name="phone_number" required>
                </div>

                <div class="form-group">
                    <label>Assigned VA</label>
                    <select name="va_id" id="edit-phone-va-select">
                        <option value="">None</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Handout Date</label>
                    <input type="text" name="handout_date" id="edit-phone-handout-date" placeholder="e.g., 2024-10-27 or 27.10.2024">
                    <small style="color: #888; font-size: 12px;">Enter date in any format</small>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #888;">Apple ID Credentials</h4>

                    <div class="form-group">
                        <label>Apple ID Email</label>
                        <input type="email" name="apple_id_email" id="edit-phone-apple-id-email" placeholder="example@icloud.com">
                    </div>

                    <div class="form-group">
                        <label>Apple ID Password</label>
                        <input type="password" name="apple_id_password" id="edit-phone-apple-id-password" placeholder="Apple ID password" autocomplete="new-password">
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #888;">Proxy Configuration</h4>

                    <div class="form-group">
                        <label>Proxy Address</label>
                        <input type="text" name="proxy_ip" id="edit-phone-proxy-ip" placeholder="proxy.example.com">
                    </div>

                    <div class="form-group">
                        <label>Proxy Port</label>
                        <input type="number" name="proxy_port" id="edit-phone-proxy-port" placeholder="8080">
                    </div>

                    <div class="form-group">
                        <label>Proxy Username</label>
                        <input type="text" name="proxy_username" id="edit-phone-proxy-username" placeholder="username">
                    </div>

                    <div class="form-group">
                        <label>Proxy Password</label>
                        <input type="password" name="proxy_password" id="edit-phone-proxy-password" placeholder="password" autocomplete="new-password">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>

                <button type="button" id="copy-phone-details-btn" class="btn" style="width: 100%; margin-bottom: 10px; background: rgba(59, 130, 246, 0.15); border: 1px solid #3b82f6; color: #60a5fa;">
                    üìã Copy All Details for Supervisor
                </button>
                <button type="submit" class="btn btn-success" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://va-management-backend-production.up.railway.app/api';
        let token = localStorage.getItem('va_token');
        let currentData = { vas: [], creators: [], payments: [], phones: [], paymentGroups: [], assignments: [] };

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }


        // ===== CORE UTILITIES =====
        async function api(endpoint, options = {}) {
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (!response.ok) {
                let errorMessage = `API Error (${response.status})`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.detail || errorData.message || errorMessage;
                } catch (e) {
                    // If we can't parse JSON, use the status text
                    errorMessage = response.statusText || errorMessage;
                }
                console.error('API Error Details:', errorMessage);
                throw new Error(errorMessage);
            }

            return response.json();
        }

        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-tab="${name}"]`).classList.add('active');
            document.getElementById(`${name}-section`).classList.add('active');
        }

        function populateVASelects() {
            const selects = ['payment-va-select', 'phone-va-select', 'edit-phone-va-select'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">None</option>' +
                        currentData.vas.map(va => `<option value="${va.id}">${va.full_name}</option>`).join('');
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        function populatePaymentGroupSelects() {
            console.log('populatePaymentGroupSelects called');
            console.log('currentData.paymentGroups:', currentData.paymentGroups);

            const selects = ['add-va-payment-group', 'edit-va-payment-group'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    const options = '<option value="">No Group</option>' +
                        (currentData.paymentGroups || []).map(g => `<option value="${g.id}">${g.group_name}</option>`).join('');
                    select.innerHTML = options;
                    console.log(`Populated ${selectId} with ${currentData.paymentGroups?.length || 0} payment groups`);
                    if (currentValue) select.value = currentValue;
                }
            });
        }

        function populateCreatorSelects() {
            const select = document.getElementById('edit-va-creator-select');
            if (select && currentData.creators) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">None</option>' +
                    currentData.creators.map(c => `<option value="${c.id}">${c.creator_name}</option>`).join('');
                if (currentValue) select.value = currentValue;
            }
        }

        function convertDateFormat(dateStr) {
            if (!dateStr) return '';
            // Check if already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            // Convert DD.MM.YYYY to YYYY-MM-DD
            if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
                const [day, month, year] = dateStr.split('.');
                return `${year}-${month}-${day}`;
            }
            return '';
        }

        function convertDateToBackendFormat(dateStr) {
            if (!dateStr) return null;
            // Convert YYYY-MM-DD to DD.MM.YYYY for backend
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                const [year, month, day] = dateStr.split('-');
                return `${day}.${month}.${year}`;
            }
            // Already in DD.MM.YYYY format
            if (/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
                return dateStr;
            }
            return null;
        }

        // ===== DATA LOADING =====
        async function loadDashboard() {
            try {
                const stats = await api('/dashboard');
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.statistics.vas.total_vas || 0}</div>
                        <div class="stat-label">Total VAs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.statistics.vas.active_vas || 0}</div>
                        <div class="stat-label">Active VAs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.statistics.creators.total_creators || 0}</div>
                        <div class="stat-label">Creators</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">$${stats.statistics.payments.total_amount || 0}</div>
                        <div class="stat-label">Total Payments</div>
                    </div>
                `;
            } catch (err) {
                console.error('Dashboard load failed:', err);
            }
        }

        function calculateTenure(onboardingDate) {
            if (!onboardingDate) return null;
            const start = new Date(onboardingDate);
            const now = new Date();

            let months = (now.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += now.getMonth();

            const days = now.getDate() - start.getDate();

            if (days < 0) {
                months--;
                const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                const daysInLastMonth = lastMonth.getDate();
                return { months, days: daysInLastMonth + days };
            }

            return { months, days };
        }

        // ===== PAYMENT STAGE LOGIC =====
        const PAYMENT_STAGES = [
            { month: 1, salary: 150, label: 'Month 1' },
            { month: 2, salary: 200, label: 'Month 2' },
            { month: 3, salary: 300, label: 'Month 3+' }
        ];

        // Calculate which work month the VA is in (1st, 2nd, 3rd+)
        function calculateWorkMonth(onboardingDate) {
            if (!onboardingDate) return 0;

            const start = new Date(onboardingDate);
            const now = new Date();

            // Calculate full months between start and now
            const yearDiff = now.getFullYear() - start.getFullYear();
            const monthDiff = now.getMonth() - start.getMonth();
            const workMonth = (yearDiff * 12) + monthDiff + 1; // +1 because first month is month 1

            return Math.max(1, workMonth);
        }

        // Check if VA is in their first month
        function isFirstMonth(onboardingDate) {
            if (!onboardingDate) return false;

            const start = new Date(onboardingDate);
            const now = new Date();

            return start.getMonth() === now.getMonth() &&
                   start.getFullYear() === now.getFullYear();
        }

        // Calculate pro-rated salary for partial first month
        function calculateProRatedSalary(onboardingDate, baseSalary) {
            const start = new Date(onboardingDate);
            const startDay = start.getDate();

            // If started on the 1st, no pro-rating needed
            if (startDay === 1) return baseSalary;

            // Calculate days worked in the first month
            const daysInMonth = new Date(start.getFullYear(), start.getMonth() + 1, 0).getDate();
            const daysWorked = daysInMonth - startDay + 1; // +1 to include start day

            // Pro-rate: (salary / 30) * days_worked
            return Math.round((baseSalary / 30) * daysWorked * 100) / 100;
        }

        // Get payment stage information for a VA
        function getPaymentStage(onboardingDate) {
            if (!onboardingDate) return null;

            const workMonth = calculateWorkMonth(onboardingDate);

            // Determine current stage (max out at month 3)
            const stageIndex = Math.min(workMonth - 1, PAYMENT_STAGES.length - 1);
            const currentStage = PAYMENT_STAGES[stageIndex];

            // Determine next stage (null if already at max)
            const nextStage = workMonth < PAYMENT_STAGES.length ?
                PAYMENT_STAGES[workMonth] : null;

            // Calculate actual salary (pro-rated if first month and mid-month start)
            let actualSalary = currentStage.salary;
            if (isFirstMonth(onboardingDate)) {
                actualSalary = calculateProRatedSalary(onboardingDate, currentStage.salary);
            }

            return {
                workMonth,
                currentStage: currentStage.month,
                currentStageLabel: currentStage.label,
                currentSalary: currentStage.salary,
                actualSalary: actualSalary,
                isProRated: isFirstMonth(onboardingDate) && actualSalary !== currentStage.salary,
                nextStage: nextStage?.month || null,
                nextStageLabel: nextStage?.label || null,
                nextSalary: nextStage?.salary || null,
                isMaxLevel: workMonth >= PAYMENT_STAGES.length
            };
        }

        async function loadVAs() {
            try {
                currentData.vas = await api('/vas');

                // Filter out archived VAs for the Virtual Assistants page
                const activeVAs = currentData.vas.filter(va => va.status !== 'archived');

                populateVASelects();
                const list = document.getElementById('va-list');
                list.innerHTML = activeVAs.map(va => {
                    const paymentStage = va.va_type === 'social_media' && va.onboarding_date ? getPaymentStage(va.onboarding_date) : null;
                    const tenure = va.onboarding_date ? calculateTenure(va.onboarding_date) : null;
                    const tenureText = tenure ? `${tenure.months} month${tenure.months !== 1 ? 's' : ''}, ${tenure.days} day${tenure.days !== 1 ? 's' : ''}` : '';
                    const cleanTelegramHandle = va.telegram_handle ? va.telegram_handle.replace(/^@+/, '') : 'N/A';

                    return `
                    <div class="card">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            ${va.profile_photo_url ? `
                                <img src="${va.profile_photo_url}" alt="${va.full_name}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6;">
                            ` : `
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                                    ${va.full_name.charAt(0)}
                                </div>
                            `}
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0;">${va.full_name}</h3>
                                <div class="card-info">
                                    <div><strong>Telegram:</strong> @${cleanTelegramHandle}</div>
                                    <div><strong>Managing Creator:</strong> ${va.creator_name || 'Not assigned'}</div>
                                    <div><strong>Joined:</strong> ${va.onboarding_date ? new Date(va.onboarding_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A'}${tenure ? ` (${tenureText})` : ''}</div>
                                    <div><strong>Status:</strong> ${va.status}</div>
                                    <div><strong>Type:</strong> ${va.va_type || 'N/A'}</div>
                                    ${paymentStage ? `
                                        <div style="margin-top: 8px; padding: 8px; background: #1a1a1a; border-radius: 6px; border-left: 3px solid #3b82f6;">
                                            <div><strong>üí∞ Current Salary:</strong> $${paymentStage.actualSalary}${paymentStage.isProRated ? ' (pro-rated)' : ''}</div>
                                            ${!paymentStage.isMaxLevel ? `<div style="font-size: 12px; color: #888;">Next raise: $${paymentStage.nextSalary} (Month ${paymentStage.nextStage})</div>` : '<div style="font-size: 12px; color: #10b981;">‚úì Max salary level</div>'}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button data-action="edit-va" data-id="${va.id}" class="btn btn-primary">Edit</button>
                            ${!va.onboarding_complete ? `
                                <button data-action="complete-onboarding" data-id="${va.id}" data-name="${va.full_name}" class="btn btn-success" style="background: #10b981;">
                                    ‚úì Complete Onboarding
                                </button>
                            ` : ''}
                            <button data-action="offboard-va" data-id="${va.id}" data-name="${va.full_name}" class="btn btn-warning">Offboard</button>
                            <button data-action="delete-va" data-id="${va.id}" data-name="${va.full_name}" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `;
                }).join('');
            } catch (err) {
                console.error('Load VAs failed:', err);
                showToast('Failed to load VAs', 'error');
            }
        }

        async function loadAssignments() {
            try {
                currentData.assignments = await api('/creator-assignments');
            } catch (err) {
                console.error('Load assignments failed:', err);
            }
        }

        async function loadCreators() {
            try {
                currentData.creators = await api('/creators');
                // Load assignments if not already loaded
                if (!currentData.assignments || currentData.assignments.length === 0) {
                    await loadAssignments();
                }
                populateCreatorSelects();
                const list = document.getElementById('creator-list');
                list.innerHTML = currentData.creators.map(c => {
                    // Find VAs managing this creator from assignments (exclude offboarded VAs)
                    const creatorAssignments = currentData.assignments.filter(a => a.creator_id == c.id);
                    console.log(`Creator ${c.creator_name} assignments:`, creatorAssignments);
                    const managingVAs = creatorAssignments
                        .map(a => {
                            const va = currentData.vas.find(v => v.id == a.va_id);
                            console.log(`VA ${a.va_id}:`, va ? `${va.full_name} (${va.status})` : 'not found');
                            return va;
                        })
                        .filter(va => {
                            // Match the Virtual Assistants tab: exclude archived AND offboarded VAs
                            const keep = va && va.status !== 'archived' && va.status !== 'offboarded';
                            if (!keep && va) {
                                console.log(`Filtering out ${va.status} VA: ${va.full_name}`);
                            }
                            return keep;
                        });

                    // Create numbered VA list for better visibility
                    const managingVAsList = managingVAs.length > 0
                        ? managingVAs.map((va, index) => `
                            <div style="display: inline-block; margin: 4px 8px 4px 0; padding: 6px 12px; background: rgba(59, 130, 246, 0.15); border-radius: 20px; font-size: 13px;">
                                <span style="color: #60a5fa; font-weight: 600; margin-right: 6px;">#${index + 1}</span>
                                <span style="color: #e5e7eb;">${va.full_name}</span>
                            </div>
                        `).join('')
                        : '<div style="color: #888; font-style: italic;">No VA assigned</div>';

                    return `
                    <div class="card">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            ${c.profile_photo_url ? `
                                <img src="${c.profile_photo_url}" alt="${c.creator_name}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #10b981;">
                            ` : `
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                                    ${c.creator_name.charAt(0)}
                                </div>
                            `}
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 8px 0;">${c.creator_name}</h3>

                                ${c.wallet_address ? `
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <div style="font-size: 13px; color: #888; font-family: monospace; background: rgba(255, 255, 255, 0.05); padding: 6px 10px; border-radius: 6px; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            üí≥ ${c.wallet_address}
                                        </div>
                                        <button
                                            onclick="navigator.clipboard.writeText('${c.wallet_address}'); showToast('Wallet address copied!', 'success');"
                                            style="padding: 6px 12px; background: rgba(16, 185, 129, 0.15); border: 1px solid #10b981; border-radius: 6px; color: #10b981; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(16, 185, 129, 0.25)'"
                                            onmouseout="this.style.background='rgba(16, 185, 129, 0.15)'">
                                            üìã Copy
                                        </button>
                                    </div>
                                ` : ''}

                                <div style="padding: 10px 14px; background: rgba(59, 130, 246, 0.08); border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; font-weight: 600;">
                                        Managed By ${managingVAs.length > 0 ? `(${managingVAs.length})` : ''}
                                    </div>
                                    <div style="line-height: 1.8;">
                                        ${managingVAsList}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button data-action="edit-creator" data-id="${c.id}" class="btn btn-primary">Edit</button>
                            <button data-action="delete-creator" data-id="${c.id}" data-name="${c.creator_name}" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Load creators failed:', err);
                showToast('Failed to load creators', 'error');
            }
        }

        async function loadPaymentGroups() {
            try {
                currentData.paymentGroups = await api('/payments/groups');
                populatePaymentGroupSelects();
                const list = document.getElementById('payment-groups-list');
                if (currentData.paymentGroups.length === 0) {
                    list.innerHTML = '<div class="card"><p style="color: #888;">No payment groups yet</p></div>';
                    return;
                }
                list.innerHTML = currentData.paymentGroups.map(g => `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3>${g.group_name}</h3>
                                <div class="card-info">
                                    <div><strong>Leader:</strong> ${g.leader_name}</div>
                                    <div><strong>Wallet:</strong> <code style="background: #0f0f0f; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${g.wallet_address}</code></div>
                                    <div><strong>VAs:</strong> ${g.vas_count || 0} assigned</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">$${g.total_amount || 0}</div>
                                <div style="font-size: 12px; color: #888;">Total Payments</div>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 15px;">
                            <button data-action="view-group-details" data-id="${g.id}" class="btn btn-primary">View Details</button>
                            <button data-action="delete-payment-group" data-id="${g.id}" data-name="${g.group_name}" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load payment groups failed:', err);
                showToast('Failed to load payment groups', 'error');
            }
        }

        async function loadPayments() {
            try {
                currentData.payments = await api('/payments');
                const list = document.getElementById('payment-list');
                if (currentData.payments.length === 0) {
                    list.innerHTML = '<div class="card"><p style="color: #888;">No payments recorded yet</p></div>';
                    return;
                }
                list.innerHTML = currentData.payments.map(p => `
                    <div class="card">
                        <h3>$${p.amount} - ${p.va_name}</h3>
                        <div class="card-info">
                            <div><strong>Date:</strong> ${new Date(p.payment_date).toLocaleDateString()}</div>
                            ${p.notes ? `<div><strong>Notes:</strong> ${p.notes}</div>` : ''}
                        </div>
                        <div class="button-group">
                            <button data-action="delete-payment" data-id="${p.id}" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load payments failed:', err);
                showToast('Failed to load payments', 'error');
            }
        }

        async function loadPhones() {
            try {
                currentData.phones = await api('/phones');
                const list = document.getElementById('phone-list');
                if (currentData.phones.length === 0) {
                    list.innerHTML = '<div class="card"><p style="color: #888;">No phones registered yet</p></div>';
                    return;
                }
                list.innerHTML = currentData.phones.map(p => `
                    <div class="card">
                        <h3>${p.phone_number}</h3>
                        <div class="card-info">
                            <div><strong>Assigned VA:</strong> ${p.va_name || 'Unassigned'}</div>
                            ${p.handout_date ? `<div><strong>Handout Date:</strong> ${p.handout_date}</div>` : ''}
                            ${p.apple_id_email ? `<div><strong>Apple ID:</strong> ${p.apple_id_email}</div>` : ''}
                            ${p.proxy_ip ? `<div><strong>Proxy:</strong> ${p.proxy_ip}${p.proxy_port ? ':' + p.proxy_port : ''}</div>` : ''}
                            ${p.notes ? `<div><strong>Notes:</strong> ${p.notes}</div>` : ''}
                        </div>
                        <div class="button-group">
                            <button data-action="edit-phone" data-id="${p.id}" class="btn btn-primary">Edit</button>
                            <button data-action="delete-phone" data-id="${p.id}" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load phones failed:', err);
                showToast('Failed to load phones', 'error');
            }
        }

        async function loadOnboardings() {
            try {
                // Get all VAs and filter for those with incomplete onboarding
                if (!currentData.vas) {
                    currentData.vas = await api('/vas');
                }

                const pendingOnboardings = currentData.vas.filter(va =>
                    va.status === 'active' && !va.onboarding_complete
                );

                const list = document.getElementById('onboarding-list');
                if (pendingOnboardings.length === 0) {
                    list.innerHTML = '<div class="card"><p style="color: #888;">All active VAs have completed onboarding! üéâ</p></div>';
                    return;
                }

                list.innerHTML = pendingOnboardings.map(va => `
                    <div class="card">
                        <div style="display: flex; align-items: start; gap: 20px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: white; flex-shrink: 0;">
                                ${va.full_name.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <h3>${va.full_name}</h3>
                                <div class="card-info">
                                    <div><strong>Telegram:</strong> @${va.telegram_handle}</div>
                                    <div><strong>Type:</strong> ${va.va_type}</div>
                                    ${va.onboarding_date ? `<div><strong>Started:</strong> ${new Date(va.onboarding_date).toLocaleDateString()}</div>` : ''}
                                    <div style="color: #f59e0b; margin-top: 10px;">‚ö†Ô∏è Onboarding not complete</div>
                                </div>
                                <div class="button-group" style="margin-top: 15px;">
                                    <button data-action="complete-onboarding" data-id="${va.id}" data-name="${va.full_name}" class="btn btn-success">‚úì Complete Onboarding</button>
                                    <button data-action="edit-va" data-id="${va.id}" class="btn btn-primary">Edit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load onboardings failed:', err);
                showToast('Failed to load onboardings', 'error');
            }
        }

        async function loadOffboardings() {
            try {
                // Get archived VAs with offboarding details
                const archivedVAs = await api('/vas/archived/list');

                // Deduplicate by VA ID (in case API returns duplicates)
                const uniqueVAs = archivedVAs.reduce((acc, va) => {
                    if (!acc.find(v => v.id === va.id)) {
                        acc.push(va);
                    }
                    return acc;
                }, []);

                const list = document.getElementById('offboarding-list');
                if (uniqueVAs.length === 0) {
                    list.innerHTML = '<div class="card"><p style="color: #888;">No offboarded VAs yet</p></div>';
                    return;
                }

                list.innerHTML = uniqueVAs.map(va => `
                    <div class="card">
                        <div style="display: flex; align-items: start; gap: 20px;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #64748b 0%, #475569 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; color: white; flex-shrink: 0; opacity: 0.7;">
                                ${va.full_name.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <h3>${va.full_name} <span style="color: #888; font-size: 14px; font-weight: 400;">(Archived)</span></h3>
                                <div class="card-info">
                                    <div><strong>Telegram:</strong> @${va.telegram_handle}</div>
                                    <div><strong>Type:</strong> ${va.va_type}</div>
                                    ${va.onboarding_date ? `<div><strong>Joined:</strong> ${new Date(va.onboarding_date).toLocaleDateString()}</div>` : ''}
                                    ${va.offboarding_date ? `<div><strong>Offboarded:</strong> ${new Date(va.offboarding_date).toLocaleDateString()}</div>` : ''}
                                    ${va.reason ? `<div><strong>Reason:</strong> ${va.reason}</div>` : ''}
                                    ${va.final_payment ? `<div><strong>Final Payment:</strong> $${va.final_payment}</div>` : ''}
                                    ${va.phone_transferred_to_name ? `<div><strong>Phone Transferred To:</strong> ${va.phone_transferred_to_name}</div>` : ''}
                                </div>
                                <div class="button-group" style="margin-top: 15px;">
                                    <button data-action="restore-va" data-id="${va.id}" class="btn btn-success">Restore</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Load offboardings failed:', err);
                showToast('Failed to load offboardings', 'error');
            }
        }

        // ===== EVENT DELEGATION - ATTACHED IMMEDIATELY =====
        document.addEventListener('click', async function(e) {
            const el = e.target.closest('[data-action]');
            if (!el) return;

            const action = el.dataset.action;
            const id = el.dataset.id;
            const name = el.dataset.name;

            console.log('Action:', action, 'ID:', id);

            try {
                switch(action) {
                    case 'logout':
                        localStorage.removeItem('va_token');
                        location.reload();
                        break;

                    case 'close-modal':
                        hideModal(el.dataset.modal);
                        break;

                    case 'add-va':
                        showModal('add-va-modal');
                        break;

                    case 'edit-va':
                        const va = currentData.vas.find(v => v.id == id);
                        if (va) {
                            console.log('Loading VA for edit:', va);

                            document.querySelector('#edit-va-form [name="id"]').value = va.id;
                            document.querySelector('#edit-va-form [name="full_name"]').value = va.full_name;
                            document.querySelector('#edit-va-form [name="telegram_handle"]').value = va.telegram_handle || '';

                            const vaTypeSelect = document.querySelector('#edit-va-form [name="va_type"]');
                            vaTypeSelect.value = va.va_type || 'social_media';

                            // Show/hide custom salary based on VA type
                            const customSalaryGroup = document.getElementById('edit-va-custom-salary-group');
                            const customSalaryInput = document.getElementById('edit-va-custom-salary');
                            if (va.va_type && va.va_type !== 'social_media') {
                                customSalaryGroup.style.display = 'block';
                                customSalaryInput.value = va.custom_salary || '';
                            } else {
                                customSalaryGroup.style.display = 'none';
                                customSalaryInput.value = '';
                            }

                            // Convert and set onboarding date (DD.MM.YYYY ‚Üí YYYY-MM-DD)
                            const convertedDate = convertDateFormat(va.onboarding_date);
                            document.getElementById('edit-va-onboarding-date').value = convertedDate;

                            // Set status immediately
                            document.getElementById('edit-va-status').value = va.status || 'active';

                            // Ensure payment groups are loaded and populated
                            if (!currentData.paymentGroups || currentData.paymentGroups.length === 0) {
                                console.log('Payment groups not loaded, loading now...');
                                await loadPaymentGroups();
                            }
                            populatePaymentGroupSelects();

                            // Ensure creators are loaded and populate creator select
                            if (!currentData.creators || currentData.creators.length === 0) {
                                console.log('Creators not loaded, loading now...');
                                await loadCreators();
                            } else {
                                populateCreatorSelects();
                            }

                            // Set payment group and creator in setTimeout to ensure they're loaded
                            setTimeout(() => {
                                const paymentGroupSelect = document.getElementById('edit-va-payment-group');
                                paymentGroupSelect.value = va.payment_group_id || '';
                                console.log('Set payment_group_id to:', va.payment_group_id);

                                const creatorSelect = document.getElementById('edit-va-creator-select');
                                creatorSelect.value = va.creator_id || '';
                                console.log('Set creator_id to:', va.creator_id);
                            }, 50);

                            // Show existing photo if available
                            if (va.profile_photo_url) {
                                document.getElementById('edit-va-photo-url').value = va.profile_photo_url;
                                document.getElementById('edit-va-photo-img').src = va.profile_photo_url;
                                document.getElementById('edit-va-photo-name').textContent = 'Current photo';
                                document.getElementById('edit-va-photo-preview').style.display = 'flex';
                            } else {
                                document.getElementById('edit-va-photo-url').value = '';
                                document.getElementById('edit-va-photo-preview').style.display = 'none';
                            }

                            // Show modal
                            showModal('edit-va-modal');
                        }
                        break;

                    case 'offboard-va':
                        if (confirm(`Offboard ${name}?`)) {
                            await api(`/vas/${id}/offboard`, { method: 'POST', body: JSON.stringify({ status: 'offboarded' }) });
                            await loadVAs();
                            await loadCreators(); // Refresh creator list to remove offboarded VAs
                            showToast('VA offboarded successfully!');
                        }
                        break;

                    case 'delete-va':
                        if (confirm(`Delete ${name}? This cannot be undone!`)) {
                            await api(`/vas/${id}`, { method: 'DELETE' });
                            await loadVAs();
                            showToast('VA deleted successfully!');
                        }
                        break;

                    case 'restore-va':
                        if (confirm(`Restore ${name}? This will reactivate the VA.`)) {
                            await api(`/vas/${id}/restore`, { method: 'POST' });
                            await loadOffboardings();
                            await loadVAs();
                            await loadCreators(); // Refresh creator list to show restored VAs
                            showToast('VA restored successfully!');
                        }
                        break;

                    case 'add-creator':
                        showModal('add-creator-modal');
                        break;

                    case 'edit-creator':
                        const creator = currentData.creators.find(c => c.id == id);
                        if (creator) {
                            document.querySelector('#edit-creator-form [name="id"]').value = creator.id;
                            document.querySelector('#edit-creator-form [name="creator_name"]').value = creator.creator_name;
                            document.getElementById('edit-creator-wallet').value = creator.wallet_address || '';

                            // Show existing photo if available
                            if (creator.profile_photo_url) {
                                document.getElementById('edit-creator-photo-url').value = creator.profile_photo_url;
                                document.getElementById('edit-creator-photo-img').src = creator.profile_photo_url;
                                document.getElementById('edit-creator-photo-name').textContent = 'Current photo';
                                document.getElementById('edit-creator-photo-preview').style.display = 'flex';
                            } else {
                                document.getElementById('edit-creator-photo-url').value = '';
                                document.getElementById('edit-creator-photo-preview').style.display = 'none';
                            }

                            showModal('edit-creator-modal');
                        }
                        break;

                    case 'delete-creator':
                        if (confirm(`Delete ${name}?`)) {
                            await api(`/creators/${id}`, { method: 'DELETE' });
                            await loadCreators();
                            showToast('Creator deleted!');
                        }
                        break;

                    case 'add-payment-group':
                        showModal('add-payment-group-modal');
                        break;

                    case 'record-payment':
                        populateVASelects();
                        showModal('record-payment-modal');
                        break;

                    case 'delete-payment':
                        if (confirm('Delete this payment record?')) {
                            await api(`/payments/${id}`, { method: 'DELETE' });
                            await loadPayments();
                            showToast('Payment deleted!');
                        }
                        break;

                    case 'add-phone':
                        populateVASelects();
                        showModal('add-phone-modal');
                        break;

                    case 'edit-phone':
                        const phone = currentData.phones.find(p => p.id == id);
                        if (phone) {
                            document.querySelector('#edit-phone-form [name="id"]').value = phone.id;
                            document.querySelector('#edit-phone-form [name="phone_number"]').value = phone.phone_number;
                            document.querySelector('#edit-phone-form [name="notes"]').value = phone.notes || '';

                            // Populate new fields (handout_date as text now)
                            // Extract just the date portion (YYYY-MM-DD) from the ISO string
                            const handoutDate = phone.handout_date ? phone.handout_date.split('T')[0] : '';
                            document.getElementById('edit-phone-handout-date').value = handoutDate;
                            document.getElementById('edit-phone-apple-id-email').value = phone.apple_id_email || '';
                            document.getElementById('edit-phone-apple-id-password').value = phone.apple_id_password || '';
                            document.getElementById('edit-phone-proxy-ip').value = phone.proxy_ip || '';
                            document.getElementById('edit-phone-proxy-port').value = phone.proxy_port || '';
                            document.getElementById('edit-phone-proxy-username').value = phone.proxy_username || '';
                            document.getElementById('edit-phone-proxy-password').value = phone.proxy_password || '';

                            populateVASelects();
                            document.getElementById('edit-phone-va-select').value = phone.assigned_to_va_id || '';

                            // Store phone data for copy button
                            window.currentEditingPhone = phone;

                            showModal('edit-phone-modal');
                        }
                        break;

                    case 'delete-phone':
                        if (confirm('Delete this phone?')) {
                            await api(`/phones/${id}`, { method: 'DELETE' });
                            await loadPhones();
                            showToast('Phone deleted!');
                        }
                        break;

                    case 'view-group-details':
                        showToast('Group details view coming soon!', 'warning');
                        break;

                    case 'delete-payment-group':
                        if (confirm(`Delete payment group "${name}"?`)) {
                            await api(`/payments/groups/${id}`, { method: 'DELETE' });
                            await loadPaymentGroups();
                            showToast('Payment group deleted!');
                        }
                        break;
                }
            } catch (err) {
                showToast('Action failed: ' + err.message, 'error');
            }
        });

        // Copy onboarding details for supervisor
        document.getElementById('copy-onboarding-details-btn')?.addEventListener('click', function() {
            const vaId = document.getElementById('onboarding-va-id').value;
            const va = currentData.vas.find(v => v.id == vaId);
            if (!va) {
                showToast('VA not found', 'error');
                return;
            }

            // Get phone type selection
            const phoneType = document.getElementById('onboarding-phone-type').value;

            // Get creator details
            const creator = currentData.creators.find(c => c.id == va.assigned_to_creator_id);
            const creatorName = creator ? creator.creator_name : 'Not assigned';

            let phoneDetails = '';

            if (phoneType === 'transfer') {
                // Get transferred phone details
                const fromVaId = document.getElementById('phone-from-va-select').value;
                const fromVa = currentData.vas.find(v => v.id == fromVaId);
                const transferredPhone = currentData.phones.find(p => p.assigned_to_va_id == fromVaId);

                if (transferredPhone && fromVa) {
                    phoneDetails = `üìû Phone Number: ${transferredPhone.phone_number} (transferred from ${fromVa.full_name})
üìÖ Handout Date: ${transferredPhone.handout_date ? transferredPhone.handout_date.split('T')[0] : 'Not set'}

üçé Apple ID Credentials:
Email: ${transferredPhone.apple_id_email || 'Not set'}
Password: ${transferredPhone.apple_id_password || 'Not set'}

üåê Proxy Configuration:
Proxy Address: ${transferredPhone.proxy_ip || 'Not set'}
Proxy Port: ${transferredPhone.proxy_port || 'Not set'}
Proxy Username: ${transferredPhone.proxy_username || 'Not set'}
Proxy Password: ${transferredPhone.proxy_password || 'Not set'}`;
                } else {
                    phoneDetails = 'üìû Phone: Transferring from another VA (select VA to see details)';
                }
            } else if (phoneType === 'new') {
                // Get new phone details from form
                const phoneNumber = document.getElementById('onboarding-phone-number').value || 'Not entered';
                const handoutDate = document.getElementById('onboarding-handout-date').value || 'Not set';
                const appleEmail = document.getElementById('onboarding-apple-id-email').value || 'Not set';
                const applePassword = document.getElementById('onboarding-apple-id-password').value || 'Not set';
                const proxyIp = document.getElementById('onboarding-proxy-ip').value || 'Not set';
                const proxyPort = document.getElementById('onboarding-proxy-port').value || 'Not set';
                const proxyUsername = document.getElementById('onboarding-proxy-username').value || 'Not set';
                const proxyPassword = document.getElementById('onboarding-proxy-password').value || 'Not set';

                phoneDetails = `üìû Phone Number: ${phoneNumber}
üìÖ Handout Date: ${handoutDate}

üçé Apple ID Credentials:
Email: ${appleEmail}
Password: ${applePassword}

üåê Proxy Configuration:
Proxy Address: ${proxyIp}
Proxy Port: ${proxyPort}
Proxy Username: ${proxyUsername}
Proxy Password: ${proxyPassword}`;
            } else {
                phoneDetails = 'üìû Phone: Not configured yet';
            }

            // Format the message
            const message = `üì± VA Onboarding Details

üë§ VA Name: ${va.full_name}
üí¨ Telegram: @${va.telegram_handle || 'N/A'}
üé® Managing Creator: ${creatorName}

${phoneDetails}

üìù Notes: ${document.getElementById('onboarding-phone-notes')?.value || 'None'}`;

            // Copy to clipboard
            navigator.clipboard.writeText(message).then(() => {
                showToast('Onboarding details copied! Ready to send to supervisor ‚úì', 'success');
            }).catch(err => {
                showToast('Failed to copy: ' + err.message, 'error');
            });
        });

        // Copy phone details for supervisor
        document.getElementById('copy-phone-details-btn')?.addEventListener('click', function() {
            const phone = window.currentEditingPhone;
            if (!phone) {
                showToast('No phone data loaded', 'error');
                return;
            }

            // Get VA details
            const va = currentData.vas.find(v => v.id == phone.assigned_to_va_id);
            if (!va) {
                showToast('VA not found', 'error');
                return;
            }

            // Get creator details
            const creator = currentData.creators.find(c => c.id == va.assigned_to_creator_id);
            const creatorName = creator ? creator.creator_name : 'Not assigned';

            // Format the message
            const message = `üì± VA Phone Setup Details

üë§ VA Name: ${va.full_name}
üí¨ Telegram: @${va.telegram_handle || 'N/A'}
üé® Managing Creator: ${creatorName}

üìû Phone Number: ${phone.phone_number}
üìÖ Handout Date: ${phone.handout_date ? phone.handout_date.split('T')[0] : 'Not set'}

üçé Apple ID Credentials:
Email: ${phone.apple_id_email || 'Not set'}
Password: ${phone.apple_id_password || 'Not set'}

üåê Proxy Configuration:
Proxy Address: ${phone.proxy_ip || 'Not set'}
Proxy Port: ${phone.proxy_port || 'Not set'}
Proxy Username: ${phone.proxy_username || 'Not set'}
Proxy Password: ${phone.proxy_password || 'Not set'}

üìù Notes: ${phone.notes || 'None'}`;

            // Copy to clipboard
            navigator.clipboard.writeText(message).then(() => {
                showToast('Phone details copied! Ready to send to supervisor ‚úì', 'success');
            }).catch(err => {
                showToast('Failed to copy: ' + err.message, 'error');
            });
        });

        // Tab switching
        document.addEventListener('click', function(e) {
            const tab = e.target.closest('[data-tab]');
            if (tab) {
                showTab(tab.dataset.tab);
                const tabName = tab.dataset.tab;
                if (tabName === 'vas') loadVAs();
                if (tabName === 'creators') loadCreators();
                if (tabName === 'dashboard') loadDashboard();
                if (tabName === 'payments') {
                    loadPaymentGroups();
                    loadPayments();
                }
                if (tabName === 'phones') loadPhones();
                if (tabName === 'onboardings') loadOnboardings();
                if (tabName === 'offboardings') loadOffboardings();
            }
        });

        // Fix date input to prevent year overflow (e.g., 02024 -> 2024)
        document.addEventListener('change', function(e) {
            if (e.target.type === 'date' && e.target.value) {
                const dateValue = e.target.value;
                // Check if year has more than 4 digits
                const match = dateValue.match(/^(\d{5,})-(\d{2})-(\d{2})$/);
                if (match) {
                    // Take last 4 digits of year
                    const year = match[1].slice(-4);
                    const month = match[2];
                    const day = match[3];
                    e.target.value = `${year}-${month}-${day}`;
                    console.log('Fixed date from', dateValue, 'to', e.target.value);
                }
            }
        });

        // ===== FORM HANDLERS =====
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                const result = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: data.get('username'),
                        password: data.get('password')
                    })
                }).then(r => r.json());

                token = result.token;
                localStorage.setItem('va_token', token);
                hideModal('login-modal');
                await loadDashboard();
                showToast('Login successful!');
            } catch (err) {
                showToast('Login failed: ' + err.message, 'error');
            }
        });

        document.getElementById('add-va-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                const customSalary = data.get('custom_salary');
                await api('/vas', {
                    method: 'POST',
                    body: JSON.stringify({
                        full_name: data.get('full_name'),
                        telegram_handle: data.get('telegram_handle'),
                        va_type: data.get('va_type'),
                        profile_photo_url: data.get('profile_photo_url') || null,
                        custom_salary: customSalary ? parseFloat(customSalary) : null,
                        onboarding_date: data.get('onboarding_date') || null,
                        payment_group_id: data.get('payment_group_id') ? parseInt(data.get('payment_group_id')) : null,
                        status: data.get('status') || 'active'
                    })
                });
                hideModal('add-va-modal');
                e.target.reset();
                document.getElementById('add-va-photo-url').value = '';
                document.getElementById('add-va-photo-preview').style.display = 'none';
                document.getElementById('add-va-custom-salary-group').style.display = 'none';
                await loadVAs();
                showToast('VA added successfully!');
            } catch (err) {
                showToast('Failed to add VA: ' + err.message, 'error');
            }
        });

        document.getElementById('edit-va-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                // Get profile photo URL from hidden input
                const photoUrl = document.getElementById('edit-va-photo-url').value || null;

                // Get the current VA data to preserve fields we're not editing
                const vaId = data.get('id');
                const currentVA = currentData.vas.find(v => v.id == vaId);

                // Get custom salary from form if present
                const customSalary = data.get('custom_salary');

                // Convert date back to DD.MM.YYYY format for backend
                const onboardingDate = data.get('onboarding_date');
                const convertedOnboardingDate = convertDateToBackendFormat(onboardingDate);

                const payload = {
                    full_name: data.get('full_name'),
                    telegram_handle: data.get('telegram_handle'),
                    va_type: data.get('va_type'),
                    profile_photo_url: photoUrl,
                    wallet_address: currentVA?.wallet_address || null,
                    monthly_base_salary: currentVA?.monthly_base_salary || 500.00,
                    custom_salary: customSalary ? parseFloat(customSalary) : null,
                    onboarding_date: convertedOnboardingDate,
                    payment_group_id: data.get('payment_group_id') ? parseInt(data.get('payment_group_id')) : null,
                    creator_id: data.get('creator_id') ? parseInt(data.get('creator_id')) : null,
                    status: data.get('status') || 'active',
                    notes: currentVA?.notes || null
                };

                console.log('Edit VA Payload:', payload);

                await api(`/vas/${vaId}`, {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });

                // Also update creator-VA assignments if creator changed
                const creatorId = data.get('creator_id') ? parseInt(data.get('creator_id')) : null;
                const oldCreatorId = currentVA?.assigned_to_creator_id;

                if (creatorId !== oldCreatorId) {
                    // Remove old assignment if exists
                    if (oldCreatorId) {
                        try {
                            await api(`/creator-assignments/${oldCreatorId}/${vaId}`, { method: 'DELETE' });
                            console.log(`Removed old assignment: Creator ${oldCreatorId} ‚Üí VA ${vaId}`);
                        } catch (err) {
                            console.warn('No old assignment to remove:', err);
                        }
                    }

                    // Add new assignment if creator selected
                    if (creatorId) {
                        try {
                            await api('/creator-assignments', {
                                method: 'POST',
                                body: JSON.stringify({
                                    creator_id: creatorId,
                                    va_id: parseInt(vaId),
                                    assigned_date: new Date().toISOString().split('T')[0]
                                })
                            });
                            console.log(`Created new assignment: Creator ${creatorId} ‚Üí VA ${vaId}`);
                        } catch (err) {
                            console.error('Failed to create assignment:', err);
                        }
                    }
                }

                hideModal('edit-va-modal');
                await loadVAs();
                await loadCreators(); // Reload creators to show updated assignments
                showToast('VA updated successfully!');
            } catch (err) {
                console.error('Edit VA Error:', err);
                showToast('Failed to update VA: ' + err.message, 'error');
            }
        });

        document.getElementById('add-creator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api('/creators', {
                    method: 'POST',
                    body: JSON.stringify({
                        creator_name: data.get('creator_name'),
                        profile_photo_url: data.get('profile_photo_url') || null,
                        wallet_address: data.get('wallet_address') || null
                    })
                });
                hideModal('add-creator-modal');
                e.target.reset();
                document.getElementById('add-creator-photo-url').value = '';
                document.getElementById('add-creator-photo-preview').style.display = 'none';
                await loadCreators();
                showToast('Creator added successfully!');
            } catch (err) {
                showToast('Failed to add creator: ' + err.message, 'error');
            }
        });

        document.getElementById('edit-creator-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api(`/creators/${data.get('id')}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        creator_name: data.get('creator_name'),
                        profile_photo_url: data.get('profile_photo_url') || null,
                        wallet_address: data.get('wallet_address') || null
                    })
                });
                hideModal('edit-creator-modal');
                await loadCreators();
                showToast('Creator updated successfully!');
            } catch (err) {
                showToast('Failed to update creator: ' + err.message, 'error');
            }
        });

        document.getElementById('add-payment-group-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api('/payments/groups', {
                    method: 'POST',
                    body: JSON.stringify({
                        group_name: data.get('group_name'),
                        leader_name: data.get('leader_name'),
                        wallet_address: data.get('wallet_address')
                    })
                });
                hideModal('add-payment-group-modal');
                e.target.reset();
                await loadPaymentGroups();
                showToast('Payment group created!');
            } catch (err) {
                showToast('Failed to create payment group: ' + err.message, 'error');
            }
        });

        document.getElementById('record-payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api('/payments', {
                    method: 'POST',
                    body: JSON.stringify({
                        va_id: parseInt(data.get('va_id')),
                        amount: parseFloat(data.get('amount')),
                        payment_date: data.get('payment_date'),
                        notes: data.get('notes')
                    })
                });
                hideModal('record-payment-modal');
                e.target.reset();
                await loadPayments();
                showToast('Payment recorded!');
            } catch (err) {
                showToast('Failed to record payment: ' + err.message, 'error');
            }
        });

        document.getElementById('add-phone-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api('/phones', {
                    method: 'POST',
                    body: JSON.stringify({
                        phone_number: data.get('phone_number'),
                        assigned_to_va_id: data.get('va_id') ? parseInt(data.get('va_id')) : null,
                        notes: data.get('notes'),
                        handout_date: data.get('handout_date') || null,
                        apple_id_email: data.get('apple_id_email') || null,
                        apple_id_password: data.get('apple_id_password') || null,
                        proxy_ip: data.get('proxy_ip') || null,
                        proxy_port: data.get('proxy_port') ? parseInt(data.get('proxy_port')) : null,
                        proxy_username: data.get('proxy_username') || null,
                        proxy_password: data.get('proxy_password') || null
                    })
                });
                hideModal('add-phone-modal');
                e.target.reset();
                await loadPhones();
                showToast('Phone added!');
            } catch (err) {
                showToast('Failed to add phone: ' + err.message, 'error');
            }
        });

        document.getElementById('edit-phone-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                await api(`/phones/${data.get('id')}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        phone_number: data.get('phone_number'),
                        assigned_to_va_id: data.get('va_id') ? parseInt(data.get('va_id')) : null,
                        notes: data.get('notes'),
                        handout_date: data.get('handout_date') || null,
                        apple_id_email: data.get('apple_id_email') || null,
                        apple_id_password: data.get('apple_id_password') || null,
                        proxy_ip: data.get('proxy_ip') || null,
                        proxy_port: data.get('proxy_port') ? parseInt(data.get('proxy_port')) : null,
                        proxy_username: data.get('proxy_username') || null,
                        proxy_password: data.get('proxy_password') || null
                    })
                });
                hideModal('edit-phone-modal');
                await loadPhones();
                showToast('Phone updated!');
            } catch (err) {
                showToast('Failed to update phone: ' + err.message, 'error');
            }
        });

        // ===== CLOUDINARY PHOTO UPLOAD =====
        const cloudinaryWidget = cloudinary.createUploadWidget({
            cloudName: 'dorheqojc',
            uploadPreset: 'va_photos',
            sources: ['local', 'camera'],
            multiple: false,
            maxFileSize: 10000000,
            clientAllowedFormats: ['png', 'jpg', 'jpeg']
        }, (error, result) => {
            if (!error && result && result.event === "success") {
                const url = result.info.secure_url;
                const context = cloudinaryWidget.currentContext;

                if (context === 'add-va') {
                    document.getElementById('add-va-photo-url').value = url;
                    document.getElementById('add-va-photo-img').src = url;
                    document.getElementById('add-va-photo-name').textContent = 'Photo uploaded';
                    document.getElementById('add-va-photo-preview').style.display = 'flex';
                } else if (context === 'edit-va') {
                    document.getElementById('edit-va-photo-url').value = url;
                    document.getElementById('edit-va-photo-img').src = url;
                    document.getElementById('edit-va-photo-name').textContent = 'Photo uploaded';
                    document.getElementById('edit-va-photo-preview').style.display = 'flex';
                } else if (context === 'add-creator') {
                    document.getElementById('add-creator-photo-url').value = url;
                    document.getElementById('add-creator-photo-img').src = url;
                    document.getElementById('add-creator-photo-name').textContent = 'Photo uploaded';
                    document.getElementById('add-creator-photo-preview').style.display = 'flex';
                } else if (context === 'edit-creator') {
                    document.getElementById('edit-creator-photo-url').value = url;
                    document.getElementById('edit-creator-photo-img').src = url;
                    document.getElementById('edit-creator-photo-name').textContent = 'Photo uploaded';
                    document.getElementById('edit-creator-photo-preview').style.display = 'flex';
                }
            }
        });

        // Add VA photo upload button
        document.getElementById('add-va-upload-photo').addEventListener('click', function() {
            cloudinaryWidget.currentContext = 'add-va';
            cloudinaryWidget.open();
        });

        // Edit VA photo upload button
        document.getElementById('edit-va-upload-photo').addEventListener('click', function() {
            cloudinaryWidget.currentContext = 'edit-va';
            cloudinaryWidget.open();
        });

        // Add Creator photo upload button
        document.getElementById('add-creator-upload-photo').addEventListener('click', function() {
            cloudinaryWidget.currentContext = 'add-creator';
            cloudinaryWidget.open();
        });

        // Edit Creator photo upload button
        document.getElementById('edit-creator-upload-photo').addEventListener('click', function() {
            cloudinaryWidget.currentContext = 'edit-creator';
            cloudinaryWidget.open();
        });

        // ===== SYNC ASSIGNMENTS BUTTON =====
        document.getElementById('sync-assignments-btn')?.addEventListener('click', async function() {
            if (!confirm('This will sync all VA-Creator assignments from the VAs table to the junction table. Continue?')) {
                return;
            }

            try {
                this.disabled = true;
                this.textContent = 'üîÑ Syncing...';

                const result = await api('/admin/migrate-populate-assignments', { method: 'POST' });

                await loadAssignments();
                await loadCreators();

                alert(`Sync complete!\n\nNew assignments: ${result.details.newAssignments}\nTotal assignments: ${result.details.totalAssignments}`);
                showToast(`‚úÖ Synced ${result.details.newAssignments} assignments!`, 'success');
            } catch (err) {
                console.error('Sync failed:', err);
                showToast('Sync failed: ' + err.message, 'error');
            } finally {
                this.disabled = false;
                this.textContent = 'üîÑ Sync All VA-Creator Assignments';
            }
        });

        // ===== VA TYPE CHANGE HANDLERS =====
        // Show/hide custom salary field based on VA type in Add VA form
        document.querySelector('#add-va-form [name="va_type"]').addEventListener('change', function(e) {
            const customSalaryGroup = document.getElementById('add-va-custom-salary-group');
            if (e.target.value === 'social_media') {
                customSalaryGroup.style.display = 'none';
                document.getElementById('add-va-custom-salary').value = '';
            } else {
                customSalaryGroup.style.display = 'block';
            }
        });

        // Show/hide custom salary field based on VA type in Edit VA form
        document.querySelector('#edit-va-form [name="va_type"]').addEventListener('change', function(e) {
            const customSalaryGroup = document.getElementById('edit-va-custom-salary-group');
            if (e.target.value === 'social_media') {
                customSalaryGroup.style.display = 'none';
                document.getElementById('edit-va-custom-salary').value = '';
            } else {
                customSalaryGroup.style.display = 'block';
            }
        });

        // ===== INIT =====
        if (token) {
            hideModal('login-modal');
            loadDashboard();
            loadVAs();
            loadCreators();
            loadPaymentGroups();
        }

        // Global migration function - call from console with: runMigration()
        window.runMigration = async function() {
            try {
                console.log('üîÑ Running migration to populate creator-VA assignments...');
                const result = await api('/admin/migrate-populate-assignments', { method: 'POST' });
                console.log('‚úÖ Migration complete!', result);
                console.log(`üìä New assignments: ${result.details.newAssignments}`);
                console.log(`üìä Total assignments: ${result.details.totalAssignments}`);
                // Reload data to reflect changes
                await loadAssignments();
                await loadCreators();
                alert(`Migration complete!\nNew assignments: ${result.details.newAssignments}\nTotal assignments: ${result.details.totalAssignments}`);
            } catch (err) {
                console.error('‚ùå Migration failed:', err);
                alert('Migration failed: ' + err.message);
            }
        };

        console.log('‚úÖ Complete VA Management System with Onboarding & Payment Flow ready!');
        console.log('üí° To run creator-VA assignment migration, type: runMigration()');
    </script>

    <!-- Onboarding & Offboarding Logic -->
    <script src="onboarding-offboarding.js"></script>
</body>
</html>
